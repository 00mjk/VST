---
name: CI

on:
  push:
    branches:
      - master
      - tcarstens/conclib
  pull_request:
    branches:
      - '**'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        coq_version:
          # See https://github.com/coq-community/docker-coq/wiki for supported images
          # - '8.13' Disabled for testing
          # - '8.14' Disabled for testing
          - '8.15'
        make_target:
          - vst
        bit_size:
          # - 32 Disabled for testing
          - 64
        exclude:
          - coq_version: 8.13
            bit_size: 32
          - coq_version: 8.14
            bit_size: 32
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - uses: coq-community/docker-coq-action@v1
        with:
          coq_version: ${{ matrix.coq_version }}
          # See https://github.com/coq-community/docker-coq-action/tree/v1 for usage
          before_install: |
            startGroup "Opam config"
              opam repo add -y prerelease file://$(pwd)/opam-prerelease
              opam update -y
              opam config list; opam repo list; opam list
            endGroup
          install: |
            startGroup "Install dependencies"
              opam install -y coq-compcert.3.10
            endGroup
          # See https://github.com/coq-community/docker-coq-action/tree/v1#permissions
          before_script: |
            startGroup "Workaround permission issue"
              sudo chmod -R a=u .
            endGroup
          script: |
            startGroup "Build & Install"
              make ${{matrix.make_target}} BITSIZE=${{matrix.bit_size}}
            endGroup
          after_script: |
            startGroup 'Copy Opam user-contrib'
              cp -R -v "$(opam var lib)"/coq/user-contrib .
            endGroup
          uninstall:
      - name: 'Create archive'
        run: tar -cpvzf archive.tgz *
      - name: 'Upload archive'
        uses: actions/upload-artifact@v2
        with:
          name: 'VST build artifacts ${{matrix.coq_version}} ${{matrix.bit_size}}'
          path: archive.tgz
          retention-days: 1

  test:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        coq_version:
          # See https://github.com/coq-community/docker-coq/wiki for supported images
          # - '8.13' Disabled for testing
          # - '8.14' Disabled for testing
          - '8.15'
        make_target:
          - test
        bit_size:
          # - 32 Disabled for testing
          - 64
        exclude:
          - coq_version: 8.13
            bit_size: 32
          - coq_version: 8.14
            bit_size: 32

    steps:
      - name: 'Download archive'
        uses: actions/download-artifact@v2
        id: download
        with:
          name: 'VST build artifacts ${{matrix.coq_version}} ${{matrix.bit_size}}'
      - name: 'Extract archive'
        run: tar -xvpzf archive.tgz
      - uses: coq-community/docker-coq-action@v1
        with:
          coq_version: ${{ matrix.coq_version }}
          install: |
            startGroup "Copy downloaded opam user-contrib"
              cp -R -v user-contrib/* "$(opam var lib)"/coq/user-contrib
            endGroup
          before_script: |
            startGroup "Workaround permission issue"
              sudo chmod -R a=u .
            endGroup
          script: |
            startGroup "Build & Install"
              make ${{matrix.make_target}} BITSIZE=${{matrix.bit_size}}
            endGroup
          uninstall:
